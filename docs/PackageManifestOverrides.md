# Package Manifest Overrides

This document describes the new Package Manifest Override system that allows you to customize the manifests generated by Komac.

## Overview

The override system allows you to:
- **Drop** certain fields from generated manifests
- **Override** existing field values 
- **Add** new fields and blocks
- **Use placeholders** that are substituted with dynamic values
- **Apply different overrides** for different manifest types (installer.yaml, locale.yaml, version.yaml)

## Override File Structure

Override files are YAML files with the following structure:

```yaml
Add:
  <normal fields / blocks go here>
Override:
  <normal fields / blocks go here>
Drop:
  - <first property / block to drop>
  - <second property / block to drop>
```

## File Locations and Precedence

Override files are loaded in the following order (later files take precedence):

1. **Package-specific override**: `overrides/{PackageIdentifier}/{ManifestType}.yaml`
2. **Package-specific default**: `overrides/{PackageIdentifier}/default.yaml`
3. **Global manifest type override**: `overrides/global/{ManifestType}.yaml`
4. **Global default override**: `overrides/global/default.yaml`

Where `{ManifestType}` can be:
- `installer` - for .installer.yaml files
- `locale` - for .locale.yaml files  
- `version` - for main package version files
- `default` - for all manifest types

## Examples

### Example 1: Locale Override

File: `overrides/MongoDB.Server/locale.yaml`

```yaml
Override:
  Tags:
    - database
    - nosql
    - mongodb
    - server
  Description: MongoDB is a document database with the scalability and flexibility that you want
  
Add:
  ReleaseNotes: |
    MongoDB Server version {VERSION} release.
    Please visit https://docs.mongodb.com/manual/release-notes/ for detailed release notes.
    
    This release includes performance improvements and bug fixes.

Drop:
  - ReleaseDate
```

### Example 2: Installer Override

File: `overrides/MongoDB.Server/installer.yaml`

```yaml
Override:
  NestedInstallerFiles:
    - RelativeFilePath: bin\mongod.exe
    - RelativeFilePath: bin\mongo.exe

Drop:
  - ReleaseDate
```

### Example 3: Global Override

File: `overrides/global/locale.yaml`

```yaml
Override:
  ManifestType: locale
  ManifestVersion: 1.6.0

Add:
  Tags:
    - utility

Drop:
  - ReleaseDate
```

## Available Placeholders

The following placeholders can be used in override values and will be substituted automatically:

- `{PACKAGE_ID}` - The package identifier (e.g., "MongoDB.Server")
- `{VERSION}` - The package version being updated (e.g., "7.0.0")
- `{CURRENT_DATE}` - Current date in YYYY-MM-DD format
- `{CURRENT_YEAR}` - Current year
- `{LATEST_*}` - Any property from the latest version info (e.g., `{LATEST_RELEASENOTES}`)

## How It Works

1. When `Update-WingetPackage` is called, it generates manifests using Komac or WinGetCreate (without submitting)
2. After generation, the system looks for applicable override files
3. Overrides are merged in precedence order
4. Placeholder substitution is performed
5. The following operations are applied to each manifest:
   - **Drop**: Specified fields are removed
   - **Override**: Existing fields are replaced with new values
   - **Add**: New fields are added (only if not already overridden)
6. If the `-Submit` parameter is true, the modified manifests are submitted using the appropriate tool's submit command

## Integration with Update-WingetPackage

The override system is automatically integrated into the `Update-WingetPackage` function. No changes to existing package scripts are required.

The system:
- Maintains backward compatibility with existing release notes functionality
- Automatically detects manifest types from filenames
- Applies overrides to all generated .yaml files
- Preserves the original Komac/WinGetCreate workflow

### Correct Workflow Sequence

The manifest generation and submission process follows this corrected sequence:

1. **Generate**: Manifests are generated using Komac or WinGetCreate in dry-run mode (no immediate submission)
2. **Override**: The override system processes the generated manifests
3. **Submit**: If the `-Submit` parameter is true, the modified manifests are submitted using the appropriate tool's submit command

This ensures that all overrides are properly applied before submission, maintaining the integrity of the customization system.

## Testing

Use the test script to validate your overrides:

```powershell
.\scripts\testing\Test-ManifestOverrides.ps1
```

This script creates sample manifests and applies the override system to verify functionality.

## Backward Compatibility

The system maintains full backward compatibility:
- Existing package scripts continue to work unchanged
- Legacy release notes parameter still functions
- No breaking changes to the existing workflow
- Override system is opt-in - packages work without override files

## Best Practices

1. **Use package-specific overrides** for package-unique customizations
2. **Use global overrides** for organization-wide standards (e.g., ManifestVersion)
3. **Prefer Override over Add** for existing fields to avoid duplication
4. **Use meaningful placeholders** to make overrides dynamic and reusable
5. **Test overrides** before deploying to ensure they produce valid manifests
6. **Document custom overrides** for maintainability